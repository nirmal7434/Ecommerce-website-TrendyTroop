{% extends 'base.html' %}
{% load static %}
{% block content %}

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">
                        <h4>Check Out</h4>
                        <div class="breadcrumb__links">
                            <a href="/">Home</a>
                            <a href="shop">Shop</a>
                            <span>Check Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Checkout Section Begin -->
    <section class="checkout spad">
        <div class="container">
            <div class="checkout__form">
                <form action="/place_order/" id="orderForm" method="POST">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-lg-8 col-md-6">
<!--                            <h6 class="coupon__code"><span class="icon_tag_alt"></span> Have a coupon? <a href="#">Click-->
<!--                            here</a> to enter your code</h6>-->
                            <h6 class="checkout__title">Billing Details</h6>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Fist Name<span>*</span></p>
                                        <input type="text" name="fname" required>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Last Name<span>*</span></p>
                                        <input type="text" name="lname" required>
                                    </div>
                                </div>
                            </div>

                            <div class="checkout__input">
                                <p>Address<span>*</span></p>
                                <input type="text" name="address" placeholder="Address" required>
                            </div>
                            <div class="checkout__input">
                                <p>Town/City<span>*</span></p>
                                <input type="text" required>
                            </div>

                            <div class="checkout__input">
                                <p>Postcode / ZIP<span>*</span></p>
                                <input type="text" required>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Phone<span>*</span></p>
                                        <input type="text" name="phone" required>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Email<span>*</span></p>
                                        <input type="text" name="email" required>
                                    </div>
                                </div>
                            </div>
<!--                            <div class="checkout__input__checkbox">-->
<!--                                <label for="acc">-->
<!--                                    Create an account?-->
<!--                                    <input type="checkbox" id="acc">-->
<!--                                    <span class="checkmark"></span>-->
<!--                                </label>-->
<!--                                <p>Create an account by entering the information below. If you are a returning customer-->
<!--                                please login at the top of the page</p>-->
<!--                            </div>-->
<!--                            <div class="checkout__input">-->
<!--                                <p>Account Password<span>*</span></p>-->
<!--                                <input type="text">-->
<!--                            </div>-->
<!--                            <div class="checkout__input__checkbox">-->
<!--                                <label for="diff-acc">-->
<!--                                    Note about your order, e.g, special noe for delivery-->
<!--                                    <input type="checkbox" id="diff-acc">-->
<!--                                    <span class="checkmark"></span>-->
<!--                                </label>-->
<!--                            </div>-->
<!--                            <div class="checkout__input">-->
<!--                                <p>Order notes<span>*</span></p>-->
<!--                                <input type="text"-->
<!--                                placeholder="Notes about your order, e.g. special notes for delivery.">-->
<!--                            </div>-->
                        </div>

                        <div class="col-lg-4 col-md-6">
    <div class="checkout__order">
        <h4 class="order__title">Your order</h4>
       <div class="checkout__order__products">
    <b>Product</b> <span><b>Total</b></span>
</div>
        {% for item in cart_order %}
        <ul class="checkout__total__products">
            <li>{{ item.product_size.product_info.name }} <span>Rs.{{ item.product_size.product_info.price }}</span></li>
            <li>Quantity: {{ item.quantity }}</li>
        </ul>
        {% endfor %}
        <ul class="checkout__total__all">
            <li>Total <span>Rs.{{ cart_total }}</span></li>
            {% if discount %}
            <li>Discount<span>Rs.{{ discount }}</span></li>
            <li>Final Total<span>Rs.{{ final_total }}</span></li>
            {% else %}
            <li>Final Total<span>Rs.{{ cart_total }}</span></li>
            {% endif %}
        </ul>

        <div class="checkout__input__radio">
            <label for="cod">
                <input type="radio" id="cod" name="payment_method" value="COD">
                Cash on Delivery
            </label>
        </div>

        <div class="checkout__input__radio">
            <label for="razorpay">
                <input type="radio" id="razorpay" name="payment_method" value="Razorpay">
                Razorpay
            </label>
        </div>

    </div>

    <button type="submit" id="place-order-btn" class="site-btn">Place Order</button>

</div>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <!-- Checkout Section End -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderForm = document.getElementById('orderForm');
    const errorsDiv = document.getElementById('errors');

    if (!orderForm) {
        console.error("Order form not found!");
        return;
    }

   let totalAmount = parseInt("{{ amount_in_paise|default:0 }}");
if (!totalAmount || totalAmount === 0) {
    const finalTotalElement = document.querySelector('.checkout__total__all li:last-child span');
    if (finalTotalElement) {
        const totalText = finalTotalElement.textContent.replace('Rs.', '').trim();
        totalAmount = parseFloat(totalText) * 100; // convert rupees to paise
    }
}


    orderForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent default form submission

        const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked');

        if (!selectedPaymentMethod) {
            if (errorsDiv) errorsDiv.textContent = "Please select a payment method.";
            return;
        }

        const paymentMethod = selectedPaymentMethod.value;

        if (paymentMethod === 'Razorpay') {
            const options = {
                key: "rzp_test_bilBagOBVTi4lE", // Replace with your Razorpay key
                amount: totalAmount, // Amount in paise
                currency: "INR",
                name: "Trendy Troop",
                description: "Order Payment",
                 handler: function(response) {
                    const orderIdInput = document.createElement('input');
                    orderIdInput.type = 'hidden';
                    orderIdInput.name = 'razorpay_order_id';
                    orderIdInput.value = response.razorpay_order_id;

                    const paymentIdInput = document.createElement('input');
                    paymentIdInput.type = 'hidden';
                    paymentIdInput.name = 'razorpay_payment_id';
                    paymentIdInput.value = response.razorpay_payment_id;

                    orderForm.appendChild(orderIdInput);
                    orderForm.appendChild(paymentIdInput);

                    // Form submit server ma verification mate
                    orderForm.submit();
                },
                prefill: {
                    name: "{{ request.user.get_full_name }}",
                    email: "{{ request.user.email }}",
                    contact: "{{ request.user.profile.phone }}"
                },
                theme: {
                    color: "#3399cc"
                }
            };

            const rzp = new Razorpay(options);
            rzp.on('payment.failed', function(response) {
                alert('Payment failed! Reason: ' + response.error.description);
            });

            rzp.open();
        } else {
            orderForm.submit();
           setTimeout(function() {
                window.location.href = "/";
            }, 2000);
        }
    });
});
</script>


{% endblock %}